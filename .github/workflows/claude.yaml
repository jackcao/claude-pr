name: Claude Code

on:
    pull_request:
        types: [opened, synchronize]
    issue_comment:
        types: [created]
    pull_request_review_comment:
        types: [created]
    issues:
        types: [opened, assigned]
    pull_request_review:
        types: [submitted]

jobs:
    claude:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
            issues: write
            id-token: write
            actions: read # Required for Claude to read CI results on PRs
        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 1

            # 使用 GitHub App token 避免 PR 触发时的 “workflow 必须与默认分支一致” 校验
            # 需在仓库中创建 GitHub App，并配置 Variables: APP_ID；Secrets: GH_APP_PRIVATE_KEY
            - name: Create GitHub App token
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                  app-id: ${{ secrets.GH_APP_ID }}
                  private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

            - name: Run Claude Code
              id: claude
              uses: anthropics/claude-code-action@v1
              env:
                  ANTHROPIC_API_URL: "https://open.bigmodel.cn/api/anthropic"
              with:
                  anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                  github_token: ${{ steps.app-token.outputs.token }}
                  show_full_output: true
                  prompt: |
                      请严格审查代码，重点检查：
                      1. 潜在的语法错误和逻辑 bug
                      2. 代码规范和可读性问题
                      3. 性能优化建议
                  claude_args: |
                      --append-system-prompt "Follow our coding standards"
                      --model glm-5
